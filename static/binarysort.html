<!DOCTYPE html>
<html>
  <head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="./mdl/material.min.css">
<script src="./mdl/material.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="jquery-3.2.0.min.js"></script>
<script src="vue.js"></script>
<script src="https://apis.google.com/js/api.js" ></script>
<script type="text/javascript">

var scope = "https://www.googleapis.com/auth/fusiontables";
var api_key='AIzaSyAAOVWAwNLCgLRb4Y15HOZk2FSibtZZA3M';

var error = function(error) {
  console.error(error);
};

</script>
  </head>
  <body onload=handleClientLoad()>
    <div id="auth">
    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" >Authorize</button>
    <button id="signout-button" style="display: none;" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">Sign Out</button>
    </div>
    <div id="sortSelection">
        <label>Choose table <select id=sortTableList></select></label>
        <label>Choose column <select id=sortColumnList></select></label>
        <button id=sortNext class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">Get cracking :D</button>
        <img src=ring.gif name=loading style="width: 20px; height: 20px; display: none">
    </div>
    
    <div id="box" style="display:none; width: 1000px; height: 350px; border:3px double gray">
        <div class=post> 
            <dl>
                <dt>Post</dt><dd>Den {{post.dato}} av <b>{{post.avsender}}</b> (+{{post.likes}})</dd>
                <dt>Tekst</dt><dd>{{post.melding}}</dd>
                <dt v-if=post.link>Lenke</dt><dd v-if=post.link><a v-bind:href=post.link target=_blank>{{post.link}}</a></dd>
                <dt v-if=post.media>Bilde/Video</dt><dd v-if=post.media><img v-bind:src=post.media ></dd>
                <dt>Kommentarer</dt><dd v-html=post.kommentarer></dd>
                <dt>Kategorisering</dt>
                <dd>
                    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="kundeforhold-1">
                    <input type="checkbox" id="kundeforhold-1" class="mdl-checkbox__input" v-model=post.kundeforhold>
                    <span class="mdl-checkbox__label">Kundeforhold?</span>
                    </label>
                    <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="relevant-1">
                    <input type="checkbox" id="relevant-1" class="mdl-checkbox__input" v-model=post.relevant>
                    <span class="mdl-checkbox__label">relevant?</span>
                    </label>
                </dd>
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" onclick=answer(this)>Next</button>
            </dl>
        </div>
    </div>
</div>
    <script>
    var boxapp = new Vue({
        el: '#box',
        data: { post: {avsender:'Avsender', 
                       melding: 'test', 
                       kommentarer: '<ul><li>Ko</li></ul>',
                       link: '',
                       media: '',
                       likes: 0,
                       dato: 'xx. november',
                       kundeforhold: false,
                       relevant: false,
                       rowid:'99' } 
        },
        computed: {
            // computed getters to streamline properties
            bool_kundeforhold: function() {
                if(this.post.kundeforhold==='' || this.post.kundeforhold==='0' || this.post.kundeforhold===0 || this.post.kundeforhold==="NaN") {
                    return 0;
                } else {
                    return 1;
                }
            },
            bool_relevant: function() {
                if(this.post.relevant==='' || this.post.relevant==='0' || this.post.relevant===0 || this.post.relevant==="NaN") {
                    return 0;
                } else {
                    return 1;
                }
            }

        }

    });

</script>

<script type="text/javascript">
var GoogleAuth; // Google Auth object.
var signoutButton = $('#signout-button');
var authorizeButton = $('#authorize-button');
var contentBox = $('#box');
var sortSelectionBox = $('#sortSelection');

$('#sortTableList').change(function(ev, data) {
    $('[name=loading]').show();
    gapi.client.fusiontables.column.list({tableId: this.value}).then(function(response) {
        var collst = $('#sortColumnList');
        collst.empty();
        console.log('sortablelistchange list data %o', response.result);
        for(var idx=0; idx<response.result.items.length; idx++) {
            var el = response.result.items[idx];
            if(el.type === 'NUMBER' && el.name.slice(-1) == '?') { 
                collst.append( $('<option/>').val(el.name).data("tableId", this.value).html(el.name) );
            }
        }
        $('[name=loading]').hide();

    });
});

function answer (btnobj) {
  var tableId = $('#sortTableList').val();
  var ql="UPDATE "+tableId+" SET 'Relevant?'='"+boxapp.post.relevant+"', 'Kundeforhold?'='"+boxapp.post.kundeforhold+"' WHERE ROWID = '"+boxapp.post.rowid+"'";
  console.log("put %o", ql);
  contentBox.css('color', '#ccc');
  console.log('put butn: %o', btnobj);
  var loading = $('[name=loading]').clone().appendTo(btnobj).show();
  gapi.client.fusiontables.query.sql({sql:ql}).then(function(result) {
    console.log('inserted into %o ', boxapp.post.rowid);
    getnext();
    loading.remove();
    contentBox.css('color', '#000');
  });
};

function getnext() {
    var val;
    var tbl = $('#sortTableList').val();
    var s="SELECT ROWID,Melding,Kommentarer,Avsender,ID,'Relevant?',Link,Media,'Kundeforhold?',Delinger,Dato FROM "+tbl+" WHERE 'Relevant?'='' AND 'Kundeforhold?'='' LIMIT 1;"
    if(gapi.client===undefined) return;
    $('[name=loading]').show();
    gapi.client.fusiontables.query.sqlGet({sql:s}).then( function(response) {
        console.log('getnxet: %o', response);
        var obj = new Object();
        var cols = response.result.columns;
        for(var i = 0; i<cols.length; i++) {
            var colname = cols[i].toLocaleLowerCase();
            if(colname.slice(-1) == '?') {
                // column ends with '?', meaning it's a boolean column
                colname = colname.replace('?', '');
                obj[colname] = parseInt(response.result.rows[0][i], 10) == 1;
            } else {
                obj[colname] = response.result.rows[0][i];
            }
        }
        setpost(obj);
        $('[name=loading]').hide();
    });
}
function setpost(postobj) {
    //get the new post from REST and add it to our view
    boxapp.post = postobj;
    // code around bug where MDL doesnt update the visual state to the model value
    var relevant = document.getElementById('relevant-1').parentElement.MaterialCheckBox;
    boxapp.post.relevant ? relevant.check() : relevant.uncheck();
    var kundeforhold = document.getElementById('kundeforhold-1').parentElement.MaterialCheckBox;
    boxapp.post.kundeforhold ? kundeforhold.check() : kundeforhold.uncheck();
}
$('#sortNext').click(getnext);


  function handleClientLoad() {
    // Load the API's client and auth2 modules.
    // Call the initClient function after the modules load.
    gapi.load('client:auth2', initClient);
  }

 function updateSigninStatus(isSignedIn) {
    var user = GoogleAuth.currentUser.get();
    var isAuthorized = user.hasGrantedScopes(scope);
    if (isAuthorized) {
      signoutButton.show();
      authorizeButton.hide();
      contentBox.show();
      sortSelectionBox.show();
      gapi.client.fusiontables.table.list().then( function(response) {
        console.log('list %o', response);
        var l = $('#sortTableList');
        l.append($('<option disabled value="">Please select one</option>'));
        for(var idx=0; idx<response.result.items.length; idx++) {
            var el = response.result.items[idx];
            l.append($('<option/>').val(el.tableId).html(el.name));
        }

     }, error);
    } else {
      signoutButton.hide();
      authorizeButton.show();
      contentBox.hide();
      sortSelectionBox.hide();
    }
  }

function initClient() {
  gapi.client.init({
      'apiKey': api_key,
      'clientId': '957273849771-9qdui513q2tqt29ffcjeaf29sam1t10o.apps.googleusercontent.com',
      'scope': scope,
      'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/fusiontables/v2/rest']
  }).then(function () {
      GoogleAuth = gapi.auth2.getAuthInstance();

      // Listen for sign-in state changes.
      GoogleAuth.isSignedIn.listen(updateSigninStatus);

      // Handle initial sign-in state. (Determine if user is already signed in.)
      var user = GoogleAuth.currentUser.get();
      updateSigninStatus();

      authorizeButton.click(function() { GoogleAuth.signIn(); });
      signoutButton.click(function() { GoogleAuth.signOut(); });
  });
}

</script>
  </body>
</html>

